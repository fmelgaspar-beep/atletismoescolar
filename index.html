<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>InscriÃ§Ã£o â€“ Jogos Escolares (Atletismo)</title>
  <style>
    body { background:#0f172a; color:#e5e7eb; font-family:system-ui; margin:0; }
    .container{ max-width:900px; margin:20px auto; padding:16px; }
    .card{ background:#111827; border-radius:12px; padding:16px; margin-bottom:16px; }
    h1,h2{ margin:0 0 12px 0; }
    label{ display:block; margin:6px 0; color:#94a3b8; }
    input, select{ width:100%; padding:8px; border-radius:8px; border:1px solid #1f2937; background:#0b1020; color:#e5e7eb; }
    .row{ display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:12px; }
    .btn{ padding:10px 14px; border:none; border-radius:8px; cursor:pointer; margin-top:8px; }
    .btn-primary{ background:#22d3ee; color:#021015; font-weight:700; }
    .btn-danger{ background:#fb7185; color:#160709; font-weight:700; }
    .modal{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; }
    .modal-content{ background:#1e293b; padding:20px; border-radius:12px; max-width:800px; width:90%; max-height:80vh; overflow:auto; }
    table{ width:100%; border-collapse:collapse; margin-top:12px; }
    th,td{ border:1px solid #334155; padding:6px; font-size:.9rem; text-align:left; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>InscriÃ§Ã£o â€“ Atletismo Convencional â€¢ Jogos Escolares</h1>
      <p>
        Cada aluno: atÃ© <b>2 provas individuais</b> + <b>1 revezamento</b>.<br>
        Cada escola: atÃ© <b>2 atletas/prova/gÃªnero</b> + <b>1 equipe de revezamento</b>
        (4 atletas) por categoria/gÃªnero.
      </p>
    </div>

    <div class="card">
      <h2>1) IdentificaÃ§Ã£o da Unidade de Ensino</h2>
      <div class="row">
        <div>
          <label>Unidade de Ensino</label>
          <select id="school" required>
            <option value="">Selecioneâ€¦</option>
          </select>
        </div>
        <div>
          <label>Professor ResponsÃ¡vel</label>
          <input id="teacher" type="text" required />
        </div>
        <div>
          <label>Email</label>
          <input id="email" type="email" required />
        </div>
        <div>
          <label>Telefone</label>
          <input id="phone" type="tel" required />
        </div>
      </div>
    </div>

    <div class="card">
      <h2>2) InscriÃ§Ã£o de Alunos</h2>
      <div id="students"></div>
      <button class="btn btn-primary" id="addStudentBtn" type="button">+ Adicionar aluno</button>
    </div>

    <div class="card">
      <button class="btn btn-primary" id="reviewBtn" type="button">Revisar inscriÃ§Ã£o</button>
    </div>
  </div>

  <div class="modal" id="reviewModal">
    <div class="modal-content">
      <h2>RevisÃ£o da InscriÃ§Ã£o</h2>
      <div id="reviewContent"></div>
      <div style="margin-top:12px; text-align:right;">
        <button class="btn btn-danger" id="cancelReview">Cancelar</button>
        <button class="btn btn-primary" id="confirmReview">Confirmar e Enviar</button>
      </div>
    </div>
  </div>

  <template id="studentTemplate">
    <div class="card student">
      <div class="row">
        <div><label>Nome</label><input type="text" class="inp-name" required></div>
        <div><label>Data de Nascimento</label><input type="date" class="inp-dob" required></div>
        <div><label>Documento</label><input type="text" class="inp-doc" required></div>
        <div>
          <label>GÃªnero</label>
          <select class="sel-gender" required>
            <option value="">Selecioneâ€¦</option>
            <option value="MASCULINO">Masculino</option>
            <option value="FEMININO">Feminino</option>
          </select>
        </div>
        <div>
          <label>Categoria</label>
          <select class="sel-category" required></select>
        </div>
      </div>
      <div class="row">
        <div><label>Prova 1</label><select class="sel-event1"></select></div>
        <div><label>Prova 2</label><select class="sel-event2"></select></div>
        <div><label>Revezamento</label><select class="sel-relay"></select></div>
      </div>
      <button class="btn btn-danger btnRemove" type="button">Remover</button>
    </div>
  </template>

  <script>
    const WEBAPP_URL =
  "https://script.google.com/macros/s/AKfycbxUvGDIWS00gJHA_KXz52oJGHVANS1v8TpXaVr0UC2oa7fQsXq-cvsX2ivYDp9ARvVDhA/exec";

    const SCHOOLS = {
      "COLÃ‰GIO MADRE FRANCISCA LAMPEL": ["MIRIM MASCULINO","MIRIM FEMININO","INFANTIL MASCULINO","INFANTIL FEMININO","INFANTO MASCULINO"],
      "COLÃ‰GIO UNI": ["MIRIM MASCULINO","MIRIM FEMININO","INFANTIL MASCULINO","INFANTIL FEMININO","INFANTO MASCULINO","INFANTO FEMININO"],
      "EEB DOLORES L. S. KRAUSS": ["MIRIM MASCULINO","MIRIM FEMININO","INFANTIL MASCULINO","INFANTIL FEMININO"],
      "EEB FERANDINO DAGNONI": ["MIRIM MASCULINO","MIRIM FEMININO","INFANTIL MASCULINO","INFANTIL FEMININO"],
      "EEB FREI GODOFREDO": ["MIRIM MASCULINO","MIRIM FEMININO","INFANTIL MASCULINO","INFANTIL FEMININO","INFANTO MASCULINO","INFANTO FEMININO"],
      "EEB FREI POLICARPO": ["MIRIM MASCULINO","MIRIM FEMININO","INFANTIL MASCULINO","INFANTIL FEMININO","INFANTO MASCULINO","INFANTO FEMININO"],
      "EEB HONÃ“RIO MIRANDA": ["INFANTIL MASCULINO","INFANTO MASCULINO"],
      "EEB IVO DÂ´ÃQUINO": ["MIRIM MASCULINO","MIRIM FEMININO","INFANTIL MASCULINO","INFANTIL FEMININO"],
      "EEB LUIZ FRANZÃ“I": ["MIRIM MASCULINO","MIRIM FEMININO","INFANTIL MASCULINO","INFANTIL FEMININO"],
      "EEB MARINA VIEIRA LEAL": ["MIRIM MASCULINO","MIRIM FEMININO","INFANTIL MASCULINO","INFANTIL FEMININO","INFANTO MASCULINO","INFANTO FEMININO"],
      "EEB NORMA MÃ”NICA SABEL": ["MIRIM MASCULINO","MIRIM FEMININO","INFANTIL MASCULINO","INFANTIL FEMININO"],
      "EEB PROF OLÃMPIO MORETTO": ["MIRIM MASCULINO","MIRIM FEMININO","INFANTIL MASCULINO","INFANTIL FEMININO"],
      "IFSC - INSTITUTO FEDERAL DE SC": ["INFANTO MASCULINO","INFANTO FEMININO"]
    };

    const provasPorCategoria = {
      "MIRIM": ["50m","100m","Salto em distÃ¢ncia","Arremesso de peso"],
      "INFANTIL": ["100m","200m","400m","Salto em altura","LanÃ§amento de dardo"],
      "INFANTO": ["400m","800m","1500m","Salto triplo","Arremesso de disco"]
    };

    const revezamentos = ["4x100m","4x400m"];
    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];

    const studentTpl = $("#studentTemplate");
    const schoolSel   = $("#school");

    // Preenche escolas
    Object.keys(SCHOOLS).forEach(name => {
      const o = document.createElement("option");
      o.value = name;
      o.textContent = name;
      schoolSel.appendChild(o);
    });

    // Eventos
    $("#addStudentBtn").onclick = addStudent;
    $("#reviewBtn").onclick     = () => {
      const data = collectData();
      if (!data) return;
      showReview(data);
    };
    $("#cancelReview").onclick  = () => $("#reviewModal").style.display = "none";
    $("#confirmReview").onclick = () => {
      const data = collectData();
      if (!data) return;

      fetch(WEBAPP_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(res => {
        $("#reviewModal").style.display = "none";

        if (res.status === "sucesso") {
          alert(res.mensagem || "InscriÃ§Ã£o enviada com sucesso!");
          location.reload();
        } else {
          alert("Erros:\n" + (res.mensagens || []).join("\n"));
        }
      })
      .catch(err => {
        $("#reviewModal").style.display = "none";
        alert("Erro ao enviar: " + err.message);
      });
    };

    function addStudent() {
      const node = studentTpl.content.firstElementChild.cloneNode(true);
      $(".btnRemove", node).onclick = () => node.remove();

      const selGender   = $(".sel-gender", node);
      const selCategory = $(".sel-category", node);
      const selEvent1   = $(".sel-event1", node);
      const selEvent2   = $(".sel-event2", node);
      const selRelay    = $(".sel-relay", node);
      const inpDob      = $(".inp-dob", node);

      // ðŸ”¹ Atualiza categorias ao mudar data de nascimento ou gÃªnero
      inpDob.onchange = atualizarCategorias;
      selGender.onchange = atualizarCategorias;

      function atualizarCategorias() {
        selCategory.innerHTML = `<option value="">Selecioneâ€¦</option>`;
        if (schoolSel.value && selGender.value && inpDob.value) {
          const ano = new Date(inpDob.value).getFullYear();
          const categoriasPermitidas = filtrarCategoriasPorAno(ano, selGender.value, schoolSel.value);
          categoriasPermitidas.forEach(cat => {
            selCategory.innerHTML += `<option>${cat}</option>`;
          });
        }
      }

      selCategory.onchange = () => {
        const key    = selCategory.value.split(" ")[0];
        const provas = provasPorCategoria[key] || [];
        selEvent1.innerHTML = `<option value="">Selecioneâ€¦</option>`;
        selEvent2.innerHTML = `<option value="">Selecioneâ€¦</option>`;
        provas.forEach(p => {
          selEvent1.innerHTML += `<option>${p}</option>`;
          selEvent2.innerHTML += `<option>${p}</option>`;
        });
        selRelay.innerHTML = `<option value="">NÃ£o</option>`;
        revezamentos.forEach(r => selRelay.innerHTML += `<option>${r}</option>`);
      };

      // Evita duplicar prova1/prova2 no mesmo aluno
      [selEvent1, selEvent2].forEach(current => {
        const other = current === selEvent1 ? selEvent2 : selEvent1;
        current.onchange = () => {
          const val = current.value;
          if (val && other.value === val) {
            alert("Este aluno jÃ¡ escolheu essa prova no outro campo.");
            current.value = "";
            return;
          }
        };
      });

      $("#students").appendChild(node);
    }

    // ðŸ”¹ FunÃ§Ã£o que aplica regra idade â†” categoria
    function filtrarCategoriasPorAno(ano, genero, escola) {
      let categorias = SCHOOLS[escola] || [];
      let permitidas = [];

      categorias.forEach(cat => {
        if (cat.includes("MIRIM") && ano >= 2012 && ano <= 2015) permitidas.push(cat);
        if (cat.includes("INFANTIL") && ano >= 2010 && ano <= 2012) permitidas.push(cat);
        if (cat.includes("INFANTO") && ano >= 2008 && ano <= 2010) permitidas.push(cat);
      });

      return permitidas;
    }

    function collectData() {
      const school  = schoolSel.value;
      if (!school) { alert("Selecione a escola."); return null; }
      const teacher = $("#teacher").value;
      const email   = $("#email").value;
      const phone   = $("#phone").value;
      const students = [];
      let valid = true;

      $$(".student").forEach(c => {
        const st = {
          name:     $(".inp-name", c).value,
          dob:      $(".inp-dob",  c).value,
          doc:      $(".inp-doc",  c).value,
          gender:   $(".sel-gender",  c).value,
          category: $(".sel-category", c).value,
          prova1:   $(".sel-event1",  c).value,
          prova2:   $(".sel-event2",  c).value,
          relay:    $(".sel-relay",   c).value
        };
        if (!st.name || !st.dob || !st.doc || !st.gender || !st.category) {
          valid = false;
        }
        students.push(st);
      });

      if (!valid) {
        alert("Preencha todos os campos dos alunos.");
        return null;
      }
      return { school, teacher, email, phone, students };
    }

    function showReview(data) {
      let html = `
        <p>
          <b>Escola:</b> ${data.school}<br>
          <b>Professor:</b> ${data.teacher}<br>
          <b>Email:</b> ${data.email}<br>
          <b>Telefone:</b> ${data.phone}
        </p>
        <table>
          <thead>
            <tr>
              <th>Nome</th><th>Nascimento</th><th>Doc</th>
              <th>GÃªnero</th><th>Categoria</th>
              <th>Prova 1</th><th>Prova 2</th><th>Revezamento</th>
            </tr>
          </thead>
          <tbody>
      `;
      data.students.forEach(s => {
        html += `
          <tr>
            <td>${s.name}</td><td>${s.dob}</td><td>${s.doc}</td>
            <td>${s.gender}</td><td>${s.category}</td>
            <td>${s.prova1}</td><td>${s.prova2}</td><td>${s.relay}</td>
          </tr>
        `;
      });
      html += `</tbody></table>`;
      $("#reviewContent").innerHTML = html;
      $("#reviewModal").style.display = "flex";
    }
  </script>
</body>
</html>
