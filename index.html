<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Inscrição Atletismo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .student { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
    label { display: block; margin-top: 5px; }
    input, select { width: 100%; padding: 5px; margin: 2px 0 10px; }
    button { padding: 10px 15px; margin-top: 10px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>Formulário de Inscrição - Atletismo</h2>

  <label>Escola:</label>
  <select id="school">
    <option value="">Selecione...</option>
    <option>Escola A</option>
    <option>Escola B</option>
    <option>Escola C</option>
  </select>

  <label>Professor Responsável:</label>
  <input type="text" id="teacher">

  <label>Email:</label>
  <input type="email" id="email">

  <label>Telefone:</label>
  <input type="text" id="phone">

  <label>Modalidade:</label>
  <select id="mode" onchange="toggleMode()">
    <option value="convencional">Convencional</option>
    <option value="paradesporto">Paradesporto</option>
  </select>

  <div id="students"></div>
  <button type="button" onclick="addStudent()">Adicionar Aluno</button>
  <br><br>
  <button type="button" onclick="submitForm()">Enviar Inscrição</button>

  <script>
    // Configurações Airtable
    const apiKey = "SUA_APIKEY_AQUI";
    const baseId = "SEU_BASEID_AQUI";
    const tableName = "Inscricoes";
    const apiUrl = `https://api.airtable.com/v0/${baseId}/${tableName}`;

    function isParadesporto() {
      return document.getElementById("mode").value === "paradesporto";
    }

    function toggleMode() {
      document.getElementById("students").innerHTML = "";
    }

    function addStudent() {
      const container = document.createElement("div");
      container.className = "student";
      container.innerHTML = `
        <label>Nome do Aluno:</label>
        <input type="text" class="inp-name">

        <label>Data de Nascimento:</label>
        <input type="date" class="inp-dob">

        <label>Documento:</label>
        <input type="text" class="inp-doc">

        <label>Gênero:</label>
        <select class="sel-gender">
          <option value="">Selecione...</option>
          <option>Masculino</option>
          <option>Feminino</option>
        </select>

        <label>Categoria:</label>
        <select class="sel-category">
          <option value="">Selecione...</option>
          <option>Sub-14</option>
          <option>Sub-16</option>
          <option>Sub-18</option>
        </select>

        <label>Prova 1:</label>
        <select class="sel-event1">
          <option value="">Selecione...</option>
          <option>100m</option>
          <option>200m</option>
          <option>Salto em distância</option>
        </select>

        <label>Prova 2:</label>
        <select class="sel-event2">
          <option value="">Selecione...</option>
          <option>100m</option>
          <option>200m</option>
          <option>Salto em distância</option>
        </select>

        ${isParadesporto() ? `
          <label>Classificação:</label>
          <input type="text" class="sel-classification">
        ` : `
          <label>Revezamento:</label>
          <select class="sel-relay">
            <option value="">Nenhum</option>
            <option>4x100m</option>
            <option>4x400m</option>
          </select>
        `}
      `;
      document.getElementById("students").appendChild(container);
    }

    function collectData() {
      const schoolSel = document.getElementById("school");
      const school = schoolSel.value;
      if (!school) { alert("Selecione a escola."); return null; }

      const teacher = document.getElementById("teacher").value;
      const email = document.getElementById("email").value;
      const phone = document.getElementById("phone").value;

      const students = [];
      let valid = true;

      document.querySelectorAll(".student").forEach(c => {
        const st = {
          "Escola": school,
          "Professor": teacher,
          "Email": email,
          "Telefone": phone,
          "Nome Do Aluno": c.querySelector(".inp-name").value,
          "Nascimento": c.querySelector(".inp-dob").value,
          "Documento": c.querySelector(".inp-doc").value,
          "Gênero": c.querySelector(".sel-gender").value,
          "Categoria": c.querySelector(".sel-category").value,
          "Prova 1": c.querySelector(".sel-event1").value,
          "Prova 2": c.querySelector(".sel-event2").value,
          "Revezamento": isParadesporto() ? "" : c.querySelector(".sel-relay").value,
          "Classificacao": isParadesporto() ? c.querySelector(".sel-classification").value : ""
        };

        if (!st["Nome Do Aluno"] || !st["Nascimento"] || !st["Documento"] || !st["Gênero"] || !st["Categoria"]) valid = false;
        if (isParadesporto() && !st["Classificacao"]) valid = false;

        const provasEscolhidas = [st["Prova 1"], st["Prova 2"]].filter(Boolean);
        if (isParadesporto()) {
          if (provasEscolhidas.length > 3) { alert(`Aluno ${st["Nome Do Aluno"]}: máx. 3 provas.`); valid = false; }
        } else {
          const totalIndiv = provasEscolhidas.length;
          const totalRelay = st["Revezamento"] ? 1 : 0;
          if (totalIndiv > 2 || totalRelay > 1) {
            alert(`Aluno ${st["Nome Do Aluno"]}: no Convencional só pode 2 provas + 1 revezamento.`);
            valid = false;
          }
        }
        students.push(st);
      });

      if (!valid) return null;

      // Valida limites no Convencional
      if (!isParadesporto()) {
        const contador = {};
        students.forEach(st => {
          const keyCat = st["Categoria"];
          [st["Prova 1"], st["Prova 2"]].forEach(p => {
            if (p) {
              const chave = `${keyCat}|${st["Gênero"]}|${p}`;
              contador[chave] = (contador[chave] || 0) + 1;
            }
          });
          if (st["Revezamento"]) {
            const chave = `${keyCat}|${st["Gênero"]}|${st["Revezamento"]}`;
            contador[chave] = (contador[chave] || 0) + 1;
          }
        });

        for (let chave in contador) {
          if (chave.includes("4x")) {
            if (contador[chave] > 4) { alert(`Limite excedido: só 4 atletas no ${chave}.`); return null; }
          } else {
            if (contador[chave] > 2) { alert(`Limite excedido: só 2 atletas por prova/gênero/categoria (${chave}).`); return null; }
          }
        }
      }

      return students;
    }

    async function submitForm() {
      const data = collectData();
      if (!data) return;

      try {
        for (let st of data) {
          const record = { fields: st };
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${apiKey}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify(record)
          });
          if (!response.ok) throw new Error("Erro ao enviar dados.");
        }
        alert("Inscrição enviada com sucesso!");
        document.getElementById("students").innerHTML = "";
      } catch (err) {
        alert("Erro: " + err.message);
      }
    }
  </script>
</body>
</html>
