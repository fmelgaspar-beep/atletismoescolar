<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Formulário de Inscrição</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .aluno { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    select, input { margin: 5px 0; width: 100%; }
    button { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Formulário de Inscrição</h1>

  <label for="unidade">Unidade de Ensino:</label>
  <select id="unidade" onchange="atualizarCategorias()">
    <option value="">Selecione</option>
    <option value="Escola A">Escola A</option>
    <option value="Escola B">Escola B</option>
  </select>

  <div id="alunos"></div>
  <button onclick="adicionarAluno()">Adicionar Aluno</button>
  <button onclick="enviarFormulario()">Enviar</button>

  <script>
    const categoriasPorUnidade = {
      "Escola A": ["100m", "200m", "Revezamento"],
      "Escola B": ["Salto", "Lançamento", "Revezamento"]
    };

    const limitePorProva = {};
    const limiteRevezamento = { masculino: {}, feminino: {} };

    function atualizarCategorias() {
      const unidade = document.getElementById("unidade").value;
      document.querySelectorAll(".categoria").forEach(select => {
        select.innerHTML = categoriasPorUnidade[unidade]
          .map(cat => `<option value="${cat}">${cat}</option>`)
          .join("");
      });
    }

    function adicionarAluno() {
      const unidade = document.getElementById("unidade").value;
      if (!unidade) return alert("Selecione a unidade de ensino primeiro.");

      const div = document.createElement("div");
      div.className = "aluno";
      div.innerHTML = `
        <label>Nome:</label><input type="text" class="nome" />
        <label>Gênero:</label>
        <select class="genero" onchange="atualizarCategorias()">
          <option value="masculino">Masculino</option>
          <option value="feminino">Feminino</option>
        </select>
        <label>Prova 1:</label><select class="categoria prova1"></select>
        <label>Prova 2:</label><select class="categoria prova2"></select>
        <label>Revezamento:</label>
        <select class="revezamento">
          <option value="">Não</option>
          <option value="Sim">Sim</option>
        </select>
        <button onclick="this.parentElement.remove()">Remover</button>
      `;
      document.getElementById("alunos").appendChild(div);
      atualizarCategorias();
    }

    function enviarFormulario() {
      const unidade = document.getElementById("unidade").value;
      const alunos = [...document.querySelectorAll(".aluno")];
      const provasPorAluno = {};
      const provasPorEscola = {};

      for (const aluno of alunos) {
        const nome = aluno.querySelector(".nome").value.trim();
        const genero = aluno.querySelector(".genero").value;
        const prova1 = aluno.querySelector(".prova1").value;
        const prova2 = aluno.querySelector(".prova2").value;
        const revezamento = aluno.querySelector(".revezamento").value;

        if (!nome || !genero || !prova1) return alert("Preencha todos os campos obrigatórios.");

        if (prova1 === prova2) return alert(`Aluno ${nome} não pode repetir a mesma prova.`);

        const chave1 = `${unidade}-${prova1}-${genero}`;
        const chave2 = `${unidade}-${prova2}-${genero}`;

        provasPorEscola[chave1] = (provasPorEscola[chave1] || 0) + 1;
        if (prova2) provasPorEscola[chave2] = (provasPorEscola[chave2] || 0) + 1;

        if (provasPorEscola[chave1] > 2 || provasPorEscola[chave2] > 2) {
          return alert(`Limite de 2 alunos por prova por gênero excedido em ${prova1} ou ${prova2}.`);
        }

        if (revezamento === "Sim") {
          const chaveRev = `${unidade}-Revezamento-${genero}`;
          limiteRevezamento[genero][chaveRev] = (limiteRevezamento[genero][chaveRev] || 0) + 1;
          if (limiteRevezamento[genero][chaveRev] > 4) {
            return alert(`Limite de 1 equipe de revezamento por gênero excedido.`);
          }
        }
      }

      alert("Formulário validado e pronto para envio!");
     function doPost(e) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("Inscricoes");
  const data = JSON.parse(e.postData.contents);

  const unidade = data.unidade;
  const alunos = data.alunos;

  const registros = sheet.getDataRange().getValues();
  const erros = [];

  const contadorProvas = {};
  const contadorRevezamento = {};

  for (let aluno of alunos) {
    const nome = aluno.nome.trim();
    const genero = aluno.genero;
    const prova1 = aluno.prova1;
    const prova2 = aluno.prova2;
    const revezamento = aluno.revezamento;

    if (!nome || !genero || !prova1) {
      erros.push(`Aluno ${nome || "(sem nome)"} está com campos obrigatórios em branco.`);
      continue;
    }

    if (prova1 === prova2 && prova2 !== "") {
      erros.push(`Aluno ${nome} não pode repetir a mesma prova.`);
      continue;
    }

    // Validação por aluno
    let provasIndividuais = [prova1, prova2].filter(p => p !== "");
    if (provasIndividuais.length > 2) {
      erros.push(`Aluno ${nome} excedeu o limite de 2 provas individuais.`);
      continue;
    }

    // Validação por escola/gênero/prova
    for (let prova of provasIndividuais) {
      const chave = `${unidade}-${prova}-${genero}`;
      contadorProvas[chave] = (contadorProvas[chave] || 0) + 1;
      if (contadorProvas[chave] > 2) {
        erros.push(`Limite de 2 alunos por prova (${prova}) por gênero (${genero}) excedido.`);
      }
    }

    // Validação de revezamento
    if (revezamento === "Sim") {
      const chaveRev = `${unidade}-Revezamento-${genero}`;
      contadorRevezamento[chaveRev] = (contadorRevezamento[chaveRev] || 0) + 1;
      if (contadorRevezamento[chaveRev] > 4) {
        erros.push(`Limite de 1 equipe de revezamento por gênero (${genero}) excedido.`);
      }
    }
  }

  if (erros.length > 0) {
    return ContentService.createTextOutput(JSON.stringify({ status: "erro", mensagens: erros }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  // Salvar dados
  for (let aluno of alunos) {
    sheet.appendRow([
      unidade,
      aluno.nome,
      aluno.genero,
      aluno.prova1,
      aluno.prova2,
      aluno.revezamento
    ]);
  }

  return ContentService.createTextOutput(JSON.stringify({ status: "sucesso", mensagem: "Inscrição realizada com sucesso!" }))
    .setMimeType(ContentService.MimeType.JSON);
}
    }
  </script>
</body>
</html>
